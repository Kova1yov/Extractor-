<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ROBE</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700&family=Outfit:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #0c0e14;
  --s1: #111420;
  --s2: #181c2a;
  --s3: #1e2236;
  --border: #252840;
  --border2: #2e3350;
  --green: #2dff9a;
  --blue: #4d9cff;
  --yellow: #ffd166;
  --orange: #ff8c42;
  --red: #ff5470;
  --purple: #c084fc;
  --teal: #22d3ee;
  --text: #cdd5f0;
  --muted: #4a5280;
  --mono: 'JetBrains Mono', monospace;
  --ui: 'Outfit', sans-serif;
}
* { box-sizing: border-box; margin: 0; padding: 0; }
body { background: var(--bg); color: var(--text); font-family: var(--mono); min-height: 100vh; }

/* noise texture */
body::before {
  content: '';
  position: fixed; inset: 0;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='200' height='200'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='200' height='200' filter='url(%23n)' opacity='0.03'/%3E%3C/svg%3E");
  pointer-events: none; z-index: 0; opacity: 0.4;
}

.wrap { max-width: 1300px; margin: 0 auto; padding: 32px 20px 80px; position: relative; z-index: 1; }

/* â”€â”€ Header â”€â”€ */
.hdr { display: flex; align-items: center; gap: 16px; margin-bottom: 32px; }
.hdr-logo {
  background: #2d1b5e;
  width: 80px; height: 80px; border-radius: 16px;
  display: flex; align-items: center; justify-content: center;
  font-size: 32px; font-weight: 900; flex-shrink: 0;
  color: white; font-family: var(--ui);
  position: relative; overflow: hidden;
  letter-spacing: -2px;
}
.hdr-logo::after {
  content: '';
  position: absolute;
  bottom: 12px; right: 12px;
  width: 10px; height: 10px;
  border-radius: 50%;
  background: #ff0000;
}
.hdr h1 { font-family: var(--ui); font-size: 36px; font-weight: 800; color: #fff; letter-spacing: -.3px; }
.hdr-sub { font-size: 12px; color: var(--muted); margin-top: 2px; }
.hdr-right { margin-left: auto; text-align: right; }
.pill {
  display: inline-block; padding: 3px 12px; border-radius: 100px;
  font-family: var(--ui); font-size: 11px; font-weight: 600;
  border: 1px solid rgba(45,255,154,.25); color: var(--green);
  background: rgba(45,255,154,.06);
}

/* â”€â”€ Saved Directory â”€â”€ */
.saved-dir {
  background: var(--s2); border: 1px solid var(--border);
  border-radius: 12px; padding: 16px 20px; margin-bottom: 20px;
  display: none;
}
.saved-dir.active { display: block; }
.dir-header { display: flex; align-items: center; gap: 12px; margin-bottom: 12px; }
.dir-path {
  flex: 1; background: var(--s3); border: 1px solid var(--border2);
  padding: 8px 14px; border-radius: 6px; font-size: 12px;
  color: var(--green); font-family: var(--mono);
  overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
}
.dir-actions { display: flex; gap: 8px; }
.btn-icon {
  background: var(--s1); border: 1px solid var(--border2);
  color: var(--text); padding: 8px 14px;
  border-radius: 6px; font-size: 13px;
  cursor: pointer; transition: all .15s;
  display: flex; align-items: center; gap: 6px;
  font-family: var(--ui); font-weight: 600;
}
.btn-icon:hover { border-color: var(--green); color: var(--green); }
.btn-icon.refresh { color: var(--teal); }
.btn-icon.refresh:hover { border-color: var(--teal); }
.btn-icon.clear { color: var(--red); }
.btn-icon.clear:hover { border-color: var(--red); }
.dir-info { font-size: 11px; color: var(--muted); }
.dir-info b { color: var(--text); }

/* â”€â”€ Drop Zone â”€â”€ */
.drop-zone {
  border: 2px dashed var(--border2);
  border-radius: 16px; background: var(--s1);
  padding: 0; cursor: pointer;
  transition: border-color .2s, background .2s;
  overflow: hidden; position: relative;
}
.drop-zone.over, .drop-zone:hover { border-color: var(--green); background: rgba(45,255,154,.03); }
.drop-inner { padding: 44px 32px; text-align: center; }
.drop-icon { font-size: 40px; margin-bottom: 12px; display: block; }
.drop-title { font-family: var(--ui); font-size: 17px; font-weight: 700; color: #fff; margin-bottom: 6px; }
.drop-desc  { font-size: 12px; color: var(--muted); margin-bottom: 20px; }
.btn-primary {
  background: linear-gradient(135deg, var(--green), var(--teal));
  color: #000; border: none; padding: 10px 28px;
  border-radius: 8px; font-family: var(--ui); font-size: 14px; font-weight: 700;
  cursor: pointer; transition: opacity .15s, transform .1s;
}
.btn-primary:hover { opacity: .88; transform: translateY(-1px); }
.btn-primary:active { transform: translateY(0); }
#fin { display: none; }
#dir-input { display: none; }

/* â”€â”€ Progress â”€â”€ */
.prog-wrap { padding: 14px 20px; border-top: 1px solid var(--border); display: none; background: var(--s2); }
.prog-row { display: flex; align-items: center; gap: 12px; margin-bottom: 6px; }
.prog-track { flex: 1; height: 4px; background: var(--border); border-radius: 2px; overflow: hidden; }
.prog-fill { height: 100%; background: linear-gradient(90deg, var(--green), var(--teal)); border-radius: 2px; transition: width .2s; }
.prog-pct { font-size: 12px; color: var(--muted); width: 36px; text-align: right; }
.prog-label { font-size: 11px; color: var(--muted); }

/* â”€â”€ Summary stats â”€â”€ */
#summary { display: none; margin: 24px 0 20px; }
.stat-row { display: flex; gap: 10px; flex-wrap: wrap; }
.stat-box {
  flex: 1; min-width: 130px;
  background: var(--s1); border: 1px solid var(--border);
  border-radius: 12px; padding: 14px 18px; position: relative; overflow: hidden;
}
.stat-box::after { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 2px; }
.stat-box.c1::after { background: var(--green); }
.stat-box.c2::after { background: var(--blue); }
.stat-box.c3::after { background: var(--yellow); }
.stat-box.c4::after { background: var(--purple); }
.stat-box.c5::after { background: var(--orange); }
.stat-n { font-family: var(--ui); font-size: 28px; font-weight: 800; }
.stat-l { font-size: 10px; color: var(--muted); text-transform: uppercase; letter-spacing: 1px; margin-top: 2px; }

/* â”€â”€ Controls â”€â”€ */
.ctrl-bar {
  display: none; margin-bottom: 14px;
  gap: 10px; flex-wrap: wrap; align-items: center;
}
.search-wrap { flex: 0.8; min-width: 160px; position: relative; }
.search-wrap input {
  width: 100%; background: var(--s1); border: 1px solid var(--border2);
  color: var(--text); padding: 9px 14px 9px 38px;
  border-radius: 8px; font-family: var(--mono); font-size: 13px;
  outline: none; transition: border-color .15s;
}
.search-wrap input:focus { border-color: var(--green); }
.search-ico { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--muted); }

.btn-sec {
  background: var(--s1); border: 1px solid var(--border2);
  color: var(--text); padding: 8px 16px;
  border-radius: 8px; font-family: var(--ui); font-size: 12px; font-weight: 600;
  cursor: pointer; transition: all .15s; white-space: nowrap;
}
.btn-sec:hover { border-color: var(--green); color: var(--green); }
.btn-sec.active { border-color: var(--green); color: var(--green); background: rgba(45,255,154,.07); }

select.sel {
  background: var(--s1); border: 1px solid var(--border2);
  color: var(--text); padding: 8px 12px;
  border-radius: 8px; font-family: var(--mono); font-size: 12px;
  outline: none; cursor: pointer;
}

/* File filter (Ğ±Ñ–Ğ±Ğ»Ñ–Ğ¾Ñ‚ĞµĞºĞ°) - Ğ·Ğ±Ñ–Ğ»ÑŒÑˆĞµĞ½Ğ¸Ğ¹ */
#file-filter {
  flex: 1.2;
  min-width: 220px;
}

/* â”€â”€ Tab bar â”€â”€ */
.tabs {
  display: flex; gap: 2px; margin-bottom: 16px;
  background: var(--s1); padding: 4px; border-radius: 10px;
  border: 1px solid var(--border); width: fit-content; display: none;
}
.tab {
  padding: 7px 18px; border-radius: 7px;
  font-family: var(--ui); font-size: 13px; font-weight: 600;
  cursor: pointer; color: var(--muted); border: none; background: none;
  transition: all .15s; white-space: nowrap;
}
.tab:hover { color: var(--text); }
.tab.active { background: var(--s2); color: var(--green); border: 1px solid var(--border); }

.tab-panel { display: none; }
.tab-panel.active { display: block; }

/* â”€â”€ Main table â”€â”€ */
.tbl-wrap { background: var(--s1); border: 1px solid var(--border); border-radius: 14px; overflow: hidden; }

.tbl-scroll { overflow-x: auto; }
.tbl-scroll::-webkit-scrollbar { height: 5px; }
.tbl-scroll::-webkit-scrollbar-thumb { background: var(--border2); border-radius: 3px; }

table.main-tbl { width: 100%; border-collapse: collapse; font-size: 12px; min-width: 700px; }
table.main-tbl thead th {
  padding: 10px 14px; text-align: left;
  font-size: 10px; text-transform: uppercase; letter-spacing: 1px;
  color: var(--muted); border-bottom: 1px solid var(--border);
  font-family: var(--ui); font-weight: 600; white-space: nowrap;
  cursor: pointer; user-select: none;
}
table.main-tbl thead th:hover { color: var(--text); }
table.main-tbl thead th.sorted { color: var(--green); }
table.main-tbl thead th .sort-ico { margin-left: 4px; opacity: .5; }
table.main-tbl thead th.sorted .sort-ico { opacity: 1; }

table.main-tbl tbody tr { border-bottom: 1px solid rgba(255,255,255,.03); transition: background .1s; }
table.main-tbl tbody tr:last-child { border-bottom: none; }
table.main-tbl tbody tr:hover { background: rgba(255,255,255,.025); }
table.main-tbl td { padding: 10px 14px; vertical-align: middle; }

.td-file { font-size: 12px; color: var(--blue); font-weight: 600; max-width: 160px; }
.td-file span { display: block; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.td-pcb { font-size: 12px; color: var(--text); font-weight: 600; }
.td-sw  { color: var(--green); font-weight: 600; }
.td-hw  { color: var(--yellow); font-weight: 600; }
.td-module { color: var(--purple); font-size: 11px; }
.td-offset { color: var(--muted); font-size: 11px; }

.ver-badge {
  display: inline-block; padding: 2px 8px; border-radius: 4px;
  font-size: 11px; font-weight: 700; margin: 1px;
}
.ver-sw { background: rgba(45,255,154,.12); color: var(--green); }
.ver-hw { background: rgba(255,209,102,.12); color: var(--yellow); }
.ver-mod { background: rgba(192,132,252,.12); color: var(--purple); }
.ver-drv { background: rgba(255,140,66,.12); color: var(--orange); }
.ver-generic { background: rgba(77,156,255,.1); color: var(--blue); }

/* â”€â”€ Module grid view â”€â”€ */
.mod-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 12px; }
.mod-card {
  background: var(--s1); border: 1px solid var(--border);
  border-radius: 12px; padding: 16px 18px; transition: border-color .15s;
}
.mod-card:hover { border-color: var(--border2); }
.mod-card-title { font-family: var(--ui); font-size: 14px; font-weight: 700; color: #fff; margin-bottom: 4px; }
.mod-card-file { font-size: 11px; color: var(--blue); margin-bottom: 12px; }
.mod-ver-list { display: flex; flex-direction: column; gap: 5px; }
.mod-ver-row { display: flex; justify-content: space-between; align-items: center; font-size: 12px; }
.mod-ver-name { color: var(--muted); }
.mod-ver-val { font-weight: 600; }

/* â”€â”€ String table â”€â”€ */
.str-tbl { background: var(--s1); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; }
.str-tbl-head { display: grid; grid-template-columns: 140px 80px 1fr 120px; padding: 10px 16px; border-bottom: 1px solid var(--border); }
.str-tbl-head span { font-size: 10px; text-transform: uppercase; letter-spacing: 1px; color: var(--muted); font-family: var(--ui); font-weight: 600; }
.str-body { max-height: 500px; overflow-y: auto; }
.str-body::-webkit-scrollbar { width: 5px; }
.str-body::-webkit-scrollbar-thumb { background: var(--border2); border-radius: 3px; }
.str-row { display: grid; grid-template-columns: 140px 80px 1fr 120px; padding: 8px 16px; border-bottom: 1px solid rgba(255,255,255,.025); transition: background .1s; align-items: center; }
.str-row:hover { background: rgba(255,255,255,.02); }
.str-row:last-child { border-bottom: none; }

/* â”€â”€ Scrollable tbody â”€â”€ */
.tbody-scroll { max-height: 540px; overflow-y: auto; }
.tbody-scroll::-webkit-scrollbar { width: 5px; }
.tbody-scroll::-webkit-scrollbar-thumb { background: var(--border2); border-radius: 3px; }

/* â”€â”€ Empty â”€â”€ */
.empty { text-align: center; padding: 48px; color: var(--muted); font-size: 13px; }

/* â”€â”€ Error â”€â”€ */
.err-row { background: rgba(255,84,112,.06); border-bottom: 1px solid rgba(255,84,112,.15); }
.err-row td { color: var(--red); font-size: 11px; padding: 6px 14px; }

/* â”€â”€ Count line â”€â”€ */
.count-line { font-size: 11px; color: var(--muted); margin-bottom: 10px; }
.count-line b { color: var(--text); }

/* â”€â”€ Changelog â”€â”€ */
.cl-entry { background: var(--s1); border: 1px solid var(--border); border-radius: 10px; padding: 14px 18px; margin-bottom: 8px; }
.cl-file  { font-size: 11px; color: var(--blue); margin-bottom: 8px; }
.cl-line  { font-size: 12px; padding: 4px 0; border-bottom: 1px solid var(--border); }
.cl-line:last-child { border-bottom: none; }
.cl-highlight { color: var(--yellow); }

/* â”€â”€ File Changelog Panel â”€â”€ */
.file-cl-line {
  font-size: 13px; 
  line-height: 1.6; 
  padding: 10px 0; 
  border-bottom: 1px solid var(--border);
  color: var(--text);
}
.file-cl-line:last-child { border-bottom: none; }
.file-cl-line::before { 
  content: 'â€¢'; 
  color: var(--green); 
  font-weight: bold; 
  margin-right: 10px; 
}
.file-cl-highlight { 
  color: var(--yellow); 
  font-weight: 600;
}
.file-cl-empty {
  text-align: center; 
  padding: 40px; 
  color: var(--muted); 
  font-size: 13px;
}

/* â”€â”€ Animations â”€â”€ */
@keyframes fadeUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
.fade-in { animation: fadeUp .3s ease forwards; }

/* â”€â”€ Title Animations â”€â”€ */
#animated-title {
  display: inline-block;
}

#animated-title .letter {
  display: inline-block;
}

#animated-title .space {
  width: 0.3em;
}

/* Animation 1: Chaotic Scale (Default) */
.title-gradient-flow {
  color: #ffffff;
}

.title-gradient-flow .letter {
  display: inline-block;
  animation: chaoticScale 4s ease-in-out infinite, chaoticGlow 4s ease-in-out infinite;
  animation-delay: calc(var(--random) * 1s);
  transform-origin: center;
  filter: drop-shadow(0 0 0px rgba(255,255,255,0));
}

@keyframes chaoticScale {
  0%, 100% { 
    transform: scale(1);
  }
  25% { 
    transform: scale(var(--scale-1, 1.15));
  }
  50% { 
    transform: scale(var(--scale-2, 0.9));
  }
  75% { 
    transform: scale(var(--scale-3, 1.1));
  }
}

@keyframes chaoticGlow {
  0%, 100% { 
    filter: drop-shadow(0 0 2px rgba(255,255,255,0.4));
  }
  25% { 
    filter: 
      drop-shadow(-1px 0 3px rgba(255,0,0,0.5))
      drop-shadow(1px 0 3px rgba(0,255,0,0.5))
      drop-shadow(0 1px 3px rgba(0,0,255,0.5));
  }
  50% { 
    filter: 
      drop-shadow(1px 0 2px rgba(0,255,0,0.4))
      drop-shadow(0 -1px 2px rgba(0,0,255,0.4))
      drop-shadow(-1px 0 2px rgba(255,255,255,0.6));
  }
  75% { 
    filter: 
      drop-shadow(0 1px 4px rgba(0,0,255,0.6))
      drop-shadow(-1px 0 4px rgba(255,0,0,0.5))
      drop-shadow(1px -1px 4px rgba(255,255,255,0.5));
  }
}

/* Animation 2: Wave Effect */
.title-wave .letter {
  animation: wave 1.5s ease-in-out infinite;
  animation-delay: calc(var(--i) * 0.1s);
}

@keyframes wave {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-10px); }
}

/* Animation 3: Pulse Glow */
.title-pulse {
  animation: pulseGlow 2s ease-in-out infinite;
  text-shadow: 0 0 10px var(--green), 0 0 20px var(--green), 0 0 30px var(--teal);
}

@keyframes pulseGlow {
  0%, 100% { 
    opacity: 1; 
    text-shadow: 0 0 10px var(--green), 0 0 20px var(--green); 
  }
  50% { 
    opacity: 0.8; 
    text-shadow: 0 0 20px var(--green), 0 0 40px var(--teal), 0 0 60px var(--teal); 
  }
}

/* Animation 4: Typing Effect */
.title-typing {
  overflow: hidden;
  border-right: 3px solid var(--green);
  white-space: nowrap;
  animation: typing 3s steps(15) 1s infinite, blink 0.75s step-end infinite;
}

@keyframes typing {
  0%, 90%, 100% { width: 100%; }
  0%, 10% { width: 0; }
}

@keyframes blink {
  50% { border-color: transparent; }
}

/* Animation 5: Glitch Effect */
.title-glitch {
  position: relative;
  animation: glitch-skew 1s infinite;
}

.title-glitch::before,
.title-glitch::after {
  content: attr(data-text);
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
}

.title-glitch::before {
  animation: glitch-anim-1 2s infinite;
  color: var(--green);
  z-index: -1;
}

.title-glitch::after {
  animation: glitch-anim-2 2s infinite;
  color: var(--teal);
  z-index: -2;
}

@keyframes glitch-anim-1 {
  0%, 100% { transform: translate(0); }
  20% { transform: translate(-2px, 2px); }
  40% { transform: translate(-2px, -2px); }
  60% { transform: translate(2px, 2px); }
  80% { transform: translate(2px, -2px); }
}

@keyframes glitch-anim-2 {
  0%, 100% { transform: translate(0); }
  20% { transform: translate(2px, -2px); }
  40% { transform: translate(2px, 2px); }
  60% { transform: translate(-2px, -2px); }
  80% { transform: translate(-2px, 2px); }
}

@keyframes glitch-skew {
  0%, 100% { transform: skew(0deg); }
  20% { transform: skew(0.5deg); }
  40% { transform: skew(-0.5deg); }
  60% { transform: skew(0.5deg); }
  80% { transform: skew(-0.5deg); }
}

/* No animation */
.title-none {
  animation: none !important;
  background: none !important;
  -webkit-text-fill-color: var(--text) !important;
  text-shadow: none !important;
  color: var(--text) !important;
}


@media (max-width: 700px) {
  .stat-row { grid-template-columns: 1fr 1fr; }
  .str-tbl-head, .str-row { grid-template-columns: 100px 60px 1fr; }
  .str-tbl-head span:last-child, .str-row > *:last-child { display: none; }
}

/* â”€â”€ Clickable Title â”€â”€ */
#animated-title {
  cursor: pointer;
  user-select: none;
}
#animated-title:hover { opacity: .85; }
#animated-title:active { opacity: .65; }
</style>
</head>
<body>
<div class="wrap">

  <!-- Header -->
  <div class="hdr" style="justify-content: center;">
    <h1 id="animated-title" class="title-gradient-flow" onclick="cycleLibrary()" title="Click to switch library">
      <span class="letter">R</span><span class="letter">o</span><span class="letter">b</span><span class="letter">i</span><span class="letter">n</span>
      <span class="letter space"> </span>
      <span class="letter">E</span><span class="letter">x</span><span class="letter">t</span><span class="letter">r</span><span class="letter">a</span><span class="letter">c</span><span class="letter">t</span><span class="letter">o</span><span class="letter">r</span>
    </h1>
  </div>
  
  <!-- Animation Selector (Hidden by default, can be shown with Ctrl+A) -->
  <div id="animation-selector" style="display: none; position: fixed; top: 10px; right: 10px; background: var(--s2); border: 1px solid var(--border); border-radius: 8px; padding: 10px; z-index: 1000;">
    <div style="font-size: 11px; color: var(--muted); margin-bottom: 8px;">Title Animation:</div>
    <select id="animation-select" onchange="changeAnimation(this.value)" style="background: var(--s1); color: var(--text); border: 1px solid var(--border); padding: 4px 8px; border-radius: 4px; font-size: 11px;">
      <option value="gradient-flow">Chaotic Scale</option>
      <option value="wave">Wave Effect</option>
      <option value="pulse">Pulse Glow</option>
      <option value="typing">Typing Effect</option>
      <option value="glitch">Glitch Effect</option>
      <option value="none">No Animation</option>
    </select>
  </div>

  <!-- Saved Directory Section -->
  <div class="saved-dir" id="saved-dir">
    <div class="dir-header">
      <div class="dir-path" id="dir-path-display"></div>
      <div class="dir-actions">
        <button class="btn-icon refresh" onclick="refreshDirectory()" title="Refresh files from directory">
          <span>ğŸ”„</span>
          <span>Refresh</span>
        </button>
        <button class="btn-icon clear" onclick="clearSavedDirectory()" title="Clear saved directory">
          <span>âœ•</span>
          <span>Clear</span>
        </button>
      </div>
    </div>
    <div class="dir-info" id="dir-info"></div>
  </div>

  <!-- Drop zone -->
  <div class="drop-zone" id="drop">
    <div class="drop-inner">
      <span class="drop-icon" id="drop-icon">ğŸ“¦</span>
      <div class="drop-title" id="drop-title">Drop up to 250 .lib files here</div>
      <div class="drop-desc" id="drop-desc">Or click to select multiple files â€” all parsing runs in your browser</div>
      <button class="btn-primary" onclick="document.getElementById('fin').click()">â¬† Select Files</button>
      <button class="btn-primary" onclick="document.getElementById('dir-input').click()" style="margin-left: 10px">ğŸ“ Select Directory</button>
      <input type="file" id="fin" multiple accept=".lib,.a,.bin">
      <input type="file" id="dir-input" webkitdirectory directory multiple>
    </div>
    <!-- progress -->
    <div class="prog-wrap" id="pw">
      <div class="prog-row">
        <div class="prog-track"><div class="prog-fill" id="pf" style="width:0%"></div></div>
        <div class="prog-pct" id="ppct">0%</div>
      </div>
      <div class="prog-label" id="plbl">Initializing...</div>
    </div>
  </div>

  <!-- Summary -->
  <div id="summary">
    <div class="stat-row" id="stat-row"></div>
  </div>

  <!-- Tabs -->
  <div class="tabs" id="tabs">
    <button class="tab active" onclick="switchTab('versions', this)">ğŸ”¢ Versions</button>
    <button class="tab" onclick="switchTab('modules', this)">ğŸ§© Modules</button>
    <button class="tab" onclick="switchTab('strings', this)">ğŸ“ All Strings</button>
    <button class="tab" onclick="switchTab('changelog', this)">ğŸ“‹ Changelog</button>
  </div>

  <!-- Controls -->
  <div class="ctrl-bar" id="ctrl">
    <div class="search-wrap">
      <span class="search-ico">âŒ•</span>
      <input type="text" id="q" placeholder="Search..." oninput="applyFilters()">
    </div>
    <div style="position: relative;">
      <select class="sel" id="file-filter" onchange="onFileFilterChange()"><option value="">All files</option></select>

    </div>
    <select class="sel" id="cat-filter" onchange="applyFilters()">
      <option value="">All categories</option>
      <option value="VERSION_SW">SW Version</option>
      <option value="VERSION_HW">HW Version</option>
      <option value="MODULE">forte_* Module</option>
      <option value="DRIVER">Driver/Device</option>
      <option value="GENERAL">Other Version</option>
    </select>
    <button class="btn-sec" id="btn-unique" onclick="toggleUnique()">Unique only</button>
    <button class="btn-sec" onclick="exportCSV()">â¬‡ CSV</button>
    <button class="btn-sec" onclick="exportJSON()">â¬‡ JSON</button>
    <button class="btn-sec" onclick="clearAll()">âœ• Clear</button>
  </div>

  <!-- Tab panels -->
  <div id="tab-versions" class="tab-panel active"></div>
  <div id="tab-modules"  class="tab-panel"></div>
  <div id="tab-strings"  class="tab-panel"></div>
  <div id="tab-changelog" class="tab-panel"></div>

  <!-- File Changelog Panel -->
  <div id="file-changelog-panel" style="display: none; margin-top: 20px;">
    <div style="background: var(--s1); border: 1px solid var(--border); border-radius: 14px; overflow: hidden;">
      <div style="padding: 16px 20px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between;">
        <div style="display: flex; align-items: center; gap: 12px;">
          <span style="font-size: 18px;">ğŸ“‹</span>
          <div>
            <div style="font-family: var(--ui); font-size: 15px; font-weight: 700; color: var(--text);">Changelog / Annotations</div>
            <div style="font-size: 11px; color: var(--muted); margin-top: 2px;" id="changelog-filename"></div>
          </div>
        </div>
        <button class="btn-sec" onclick="closeFileChangelog()" style="padding: 6px 12px; font-size: 11px;">âœ• Close</button>
      </div>
      <div id="file-changelog-content" style="padding: 20px; max-height: 400px; overflow-y: auto;"></div>
    </div>
  </div>

</div>
<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PATTERNS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// forte_* module + version: forte_m v23 / forte_l1v27 / forte_l1_v27
const RE_FORTE = /\bforte_([a-z0-9]+)\b[_\s]*v?(\d+)/gi;

// PCB name + sw/hw versions like in the screenshot: sw33/hw10, sw12/hw10
const RE_PCB_VER = /\b(PCB\s*[A-Z][A-Z0-9]*)\s*[:\-=]?\s*((?:sw\d+\/hw\d+(?:,sw\d+\/hw\d+)*))/gi;
const RE_SWVER = /\bsw\s*(\d+[\d.]*)/gi;
const RE_HWVER = /\bhw\s*(\d+[\d.]*)/gi;

// Generic version numbers
const RE_VER_DOT = /\bv?\d{1,3}\.\d{1,3}(?:\.\d{1,5})?(?:\.\d+)?\b/g;

// Driver/device identifiers like RB3409v21
const RE_DRIVER = /\b([A-Z]{1,4}\d{3,6})[_\s]?v(\d+)\b/gi;

// rforte_dv variants
const RE_RFORTE = /\brforte_([a-z0-9_]+)\b/gi;

// Changelog lines (start with - or * and mention versions)
const RE_CL = /^[\-\*â€¢]\s*.{5,}/;

// Min string length
const MIN_LEN = 4;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let allResults   = []; // { file, offset, raw, category, pcb, module, sw, hw, ver, note }
let allStrings   = []; // { file, offset, str, category }
let allModules   = {}; // { 'forte_m': { file, versions:[] } }
let allChangelog = []; // { file, lines:[] }
let fileList     = [];
let filteredResults = []; // Currently displayed (filtered) results
let uniqueMode   = false;
let sortCol      = 'file';
let sortDir      = 1;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DROP / FILE INPUT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const drop = document.getElementById('drop');
drop.addEventListener('dragover', e => { e.preventDefault(); drop.classList.add('over'); });
drop.addEventListener('dragleave', () => drop.classList.remove('over'));
drop.addEventListener('drop', e => { e.preventDefault(); drop.classList.remove('over'); startBatch(e.dataTransfer.files); });
document.getElementById('fin').addEventListener('change', e => startBatch(e.target.files));
document.getElementById('dir-input').addEventListener('change', e => handleDirectorySelection(e.target.files));

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DIRECTORY HANDLING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let savedDirectoryHandle = null;
let savedDirectoryPath = '';

async function handleDirectorySelection(files) {
  if (!files || !files.length) return;
  
  // ĞÑ‚Ñ€Ğ¸Ğ¼ÑƒÑ”Ğ¼Ğ¾ ÑˆĞ»ÑÑ… Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ñ–Ñ— Ğ· Ğ¿ĞµÑ€ÑˆĞ¾Ğ³Ğ¾ Ñ„Ğ°Ğ¹Ğ»Ñƒ
  const firstFile = files[0];
  const fullPath = firstFile.webkitRelativePath || firstFile.name;
  const dirPath = fullPath.substring(0, fullPath.lastIndexOf('/')) || fullPath;
  
  // Ğ—Ğ±ĞµÑ€Ñ–Ğ³Ğ°Ñ”Ğ¼Ğ¾ Ñ„Ğ°Ğ¹Ğ»Ğ¸ Ñ‚Ğ° ÑˆĞ»ÑÑ…
  savedDirectoryPath = dirPath;
  localStorage.setItem('savedDirectoryPath', dirPath);
  
  // ĞŸĞ¾ĞºĞ°Ğ·ÑƒÑ”Ğ¼Ğ¾ Ğ·Ğ±ĞµÑ€ĞµĞ¶ĞµĞ½Ñƒ Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ñ–Ñ
  updateDirectoryDisplay(dirPath, files.length);
  
  // Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°Ñ”Ğ¼Ğ¾ Ğ¾Ğ±Ñ€Ğ¾Ğ±ĞºÑƒ Ñ„Ğ°Ğ¹Ğ»Ñ–Ğ²
  startBatch(files);
}

function updateDirectoryDisplay(path, fileCount) {
  const savedDirEl = document.getElementById('saved-dir');
  const pathDisplay = document.getElementById('dir-path-display');
  const infoDisplay = document.getElementById('dir-info');
  
  savedDirEl.classList.add('active');
  pathDisplay.textContent = path;
  infoDisplay.innerHTML = `ğŸ“‚ Directory saved. Found <b>${fileCount}</b> files. Click <b>Refresh</b> to reload files from this directory.`;
}

async function refreshDirectory() {
  if (!savedDirectoryPath) {
    alert('No directory saved. Please select a directory first.');
    return;
  }
  
  // ĞŸÑ€Ğ¾Ğ³Ñ€Ğ°Ğ¼Ğ½Ğ¾ ĞºĞ»Ñ–ĞºĞ°Ñ”Ğ¼Ğ¾ Ğ½Ğ° input Ğ´Ğ»Ñ Ğ²Ğ¸Ğ±Ğ¾Ñ€Ñƒ Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ñ–Ñ—
  document.getElementById('dir-input').click();
}

function clearSavedDirectory() {
  savedDirectoryPath = '';
  savedDirectoryHandle = null;
  localStorage.removeItem('savedDirectoryPath');
  
  const savedDirEl = document.getElementById('saved-dir');
  savedDirEl.classList.remove('active');
  
  clearAll();
}

// Ğ—Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ĞµĞ½Ğ½Ñ Ğ·Ğ±ĞµÑ€ĞµĞ¶ĞµĞ½Ğ¾Ñ— Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ñ–Ñ— Ğ¿Ñ€Ğ¸ ÑÑ‚Ğ°Ñ€Ñ‚Ñ–
window.addEventListener('DOMContentLoaded', () => {
  const savedPath = localStorage.getItem('savedDirectoryPath');
  if (savedPath) {
    const savedDirEl = document.getElementById('saved-dir');
    const pathDisplay = document.getElementById('dir-path-display');
    const infoDisplay = document.getElementById('dir-info');
    
    savedDirEl.classList.add('active');
    pathDisplay.textContent = savedPath;
    infoDisplay.innerHTML = `ğŸ“‚ Previous directory: <b>${savedPath}</b><br>Click <b>Refresh</b> to reload files from this directory.`;
  }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BATCH PROCESSOR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function startBatch(files) {
  clearAll(true);
  if (!files || !files.length) return;

  // Ğ¤Ñ–Ğ»ÑŒÑ‚Ñ€ÑƒÑ”Ğ¼Ğ¾ Ñ„Ğ°Ğ¹Ğ»Ğ¸ Ğ²Ñ–Ğ´Ğ¿Ğ¾Ğ²Ñ–Ğ´Ğ½Ğ¾ Ğ´Ğ¾ Ğ¿Ğ¾Ñ‚Ğ¾Ñ‡Ğ½Ğ¾Ğ³Ğ¾ Ñ€ĞµĞ¶Ğ¸Ğ¼Ñƒ Ğ±Ñ–Ğ±Ğ»Ñ–Ğ¾Ñ‚ĞµĞºĞ¸
  let validFiles;
  if (currentLib === 'roxx') {
    validFiles = Array.from(files).filter(f => f.name.toLowerCase().endsWith('.ckf'));
    if (!validFiles.length) {
      alert('No valid .ckf files found. In ROXX mode only .ckf files are supported.');
      return;
    }
  } else {
    validFiles = Array.from(files).filter(f =>
      f.name.toLowerCase().endsWith('.lib') ||
      f.name.toLowerCase().endsWith('.a')   ||
      f.name.toLowerCase().endsWith('.bin')
    );
    if (!validFiles.length) {
      alert('No valid .lib, .a, or .bin files found in the selected directory.');
      return;
    }
  }

  fileList = validFiles.slice(0, 250);
  document.getElementById('pw').style.display = 'block';

  for (let i = 0; i < fileList.length; i++) {
    const file = fileList[i];
    setProgress(i, fileList.length, file.name);
    await processFile(file, i);
  }

  setProgress(fileList.length, fileList.length, 'Complete');
  setTimeout(() => { document.getElementById('pw').style.display = 'none'; }, 600);

  renderSummary();
  renderVersionsTab();
  renderModulesTab();
  renderStringsTab();
  renderChangelogTab();
  buildFileFilter();

  document.getElementById('summary').style.display = 'block';
  document.getElementById('tabs').style.display   = 'flex';
  document.getElementById('ctrl').style.display   = 'flex';
}

function processFile(file, idx) {
  return new Promise(resolve => {
    const reader = new FileReader();
    reader.onload = e => {
      try {
        const buf = new Uint8Array(e.target.result);
        if (currentLib === 'roxx' || file.name.toLowerCase().endsWith('.ckf')) {
          parseCkf(buf, file.name);
        } else {
          parseLib(buf, file.name);
        }
      } catch(err) {
        console.error(file.name, err);
      }
      resolve();
    };
    reader.onerror = () => resolve();
    reader.readAsArrayBuffer(file);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PARSER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function parseLib(buf, filename) {
  // Extract all ASCII strings
  const strings = extractStrings(buf);

  // Changelog bucket - Ğ±ÑƒĞ´ĞµĞ¼Ğ¾ Ğ·Ğ±Ğ¸Ñ€Ğ°Ñ‚Ğ¸ Ğ±Ğ»Ğ¾ĞºĞ°Ğ¼Ğ¸
  const clLines = [];
  let currentVersionHeader = null;

  for (const { offset, str } of strings) {
    // Always store in all-strings
    const cat = categorize(str);
    allStrings.push({ file: filename, offset, str, category: cat });

    const trimmed = str.trim();
    
    // ĞŸĞµÑ€ĞµĞ²Ñ–Ñ€ÑÑ”Ğ¼Ğ¾ Ñ‡Ğ¸ Ñ†Ğµ Ğ·Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²Ğ¾Ğº Ğ²ĞµÑ€ÑÑ–Ñ—:
    // - V2, V3, v10, V14 (V Ğ°Ğ±Ğ¾ v + 1-3 Ñ†Ğ¸Ñ„Ñ€Ğ¸)
    // - 13072544, 14011651 (8 Ñ†Ğ¸Ñ„Ñ€ - Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚ Ğ´Ğ°Ñ‚Ğ¸)
    const isShortVersion = /^[Vv]\d{1,3}$/.test(trimmed);
    const isDateVersion = /^\d{8}$/.test(trimmed);
    const isVersionHeader = isShortVersion || isDateVersion;
    
    // ĞŸĞµÑ€ĞµĞ²Ñ–Ñ€ÑÑ”Ğ¼Ğ¾ Ñ‡Ğ¸ Ñ†Ğµ ÑĞ¿Ñ€Ğ°Ğ²Ğ¶Ğ½Ñ–Ğ¹ changelog Ğ·Ğ°Ğ¿Ğ¸Ñ:
    // 1. ĞŸĞ¾Ñ‡Ğ¸Ğ½Ğ°Ñ”Ñ‚ÑŒÑÑ Ğ· -, *, â€¢ (Ğ¼Ğ¾Ğ¶Ğ»Ğ¸Ğ²Ğ¾ Ğ· Ğ¿Ñ€Ğ¾Ğ±Ñ–Ğ»Ğ°Ğ¼Ğ¸)
    // 2. ĞœÑ–ÑÑ‚Ğ¸Ñ‚ÑŒ Ğ¿Ñ€Ğ¸Ğ½Ğ°Ğ¹Ğ¼Ğ½Ñ– 10 ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ñ–Ğ²
    // 3. ĞœÑ–ÑÑ‚Ğ¸Ñ‚ÑŒ Ğ¿Ñ€Ğ¸Ğ½Ğ°Ğ¹Ğ¼Ğ½Ñ– 5 Ğ»Ñ–Ñ‚ĞµÑ€ (Ğ½Ğµ Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾ ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ğ¸)
    // 4. ĞœÑ–ÑÑ‚Ğ¸Ñ‚ÑŒ Ğ¿Ñ€Ğ¾Ğ±Ñ–Ğ» (Ğ¾Ğ·Ğ½Ğ°Ñ‡Ğ°Ñ” Ñ‰Ğ¾ Ñ” ÑĞ»Ğ¾Ğ²Ğ°, Ğ° Ğ½Ğµ Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾ Ğ½Ğ°Ğ±Ñ–Ñ€ ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ñ–Ğ²)
    const startsWithMarker = /^[\s\t]*[\-\*â€¢]/.test(trimmed);
    const hasEnoughLength = trimmed.length >= 10;
    const hasEnoughLetters = (trimmed.match(/[a-zA-Z]/g) || []).length >= 5;
    const hasSpaces = /\s/.test(trimmed);
    const notTooManySpecialChars = (trimmed.match(/[^a-zA-Z0-9\s\-\*â€¢(),./]/g) || []).length < trimmed.length * 0.3;
    
    const isChangelogLine = startsWithMarker && 
                            hasEnoughLength && 
                            hasEnoughLetters && 
                            hasSpaces &&
                            notTooManySpecialChars &&
                            !hasSequentialRun(trimmed);
    
    if (isVersionHeader) {
      // Ğ—Ğ±ĞµÑ€Ñ–Ğ³Ğ°Ñ”Ğ¼Ğ¾ ÑĞº Ğ·Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²Ğ¾Ğº Ğ²ĞµÑ€ÑÑ–Ñ—
      currentVersionHeader = trimmed;
      clLines.push(''); // ĞŸÑƒÑÑ‚Ğ° Ğ»Ñ–Ğ½Ñ–Ñ Ğ´Ğ»Ñ Ğ²Ñ–Ğ´ÑÑ‚ÑƒĞ¿Ñƒ
      clLines.push(`=== ${trimmed} ===`);
    } else if (isChangelogLine) {
      // Ğ¦Ğµ ÑĞ¿Ñ€Ğ°Ğ²Ğ¶Ğ½Ñ–Ğ¹ changelog Ğ·Ğ°Ğ¿Ğ¸Ñ
      clLines.push(trimmed);
    }

    // â”€â”€ forte_* modules â”€â”€
    let m;
    const re1 = new RegExp(RE_FORTE.source, 'gi');
    while ((m = re1.exec(str)) !== null) {
      const mod = 'forte_' + m[1].toLowerCase();
      const ver = parseInt(m[2], 10);
      const key = mod;
      if (!allModules[key]) allModules[key] = { module: mod, versions: [], files: [] };
      if (!allModules[key].versions.includes(ver)) allModules[key].versions.push(ver);
      if (!allModules[key].files.includes(filename)) allModules[key].files.push(filename);
      addResult({ file: filename, offset, raw: str, category: 'MODULE', module: mod, ver: 'v' + ver, sw: '', hw: '', pcb: '' });
    }

    // â”€â”€ PCB sw/hw â”€â”€
    const re2 = new RegExp(RE_PCB_VER.source, 'gi');
    while ((m = re2.exec(str)) !== null) {
      const pcb = m[1].replace(/\s+/g,' ').trim();
      const verStr = m[2];
      const pairs = verStr.split(',');
      for (const pair of pairs) {
        const swm = pair.match(/sw(\d+[\d.]*)/i);
        const hwm = pair.match(/hw(\d+[\d.]*)/i);
        addResult({
          file: filename, offset, raw: str, category: 'VERSION_SW',
          pcb, sw: swm ? swm[1] : '', hw: hwm ? hwm[1] : '', module: '', ver: pair.trim()
        });
      }
    }

    // â”€â”€ Standalone sw / hw â”€â”€
    const re3 = new RegExp(RE_SWVER.source, 'gi');
    while ((m = re3.exec(str)) !== null) {
      addResult({ file: filename, offset, raw: str, category: 'VERSION_SW', sw: m[1], hw: '', pcb: '', module: '', ver: 'sw' + m[1] });
    }
    const re4 = new RegExp(RE_HWVER.source, 'gi');
    while ((m = re4.exec(str)) !== null) {
      addResult({ file: filename, offset, raw: str, category: 'VERSION_HW', sw: '', hw: m[1], pcb: '', module: '', ver: 'hw' + m[1] });
    }

    // â”€â”€ Generic dotted versions â”€â”€
    const re5 = new RegExp(RE_VER_DOT.source, 'g');
    while ((m = re5.exec(str)) !== null) {
      addResult({ file: filename, offset, raw: str, category: 'GENERAL', ver: m[0], sw: '', hw: '', pcb: '', module: '' });
    }

    // â”€â”€ Driver/device â”€â”€
    const re6 = new RegExp(RE_DRIVER.source, 'gi');
    while ((m = re6.exec(str)) !== null) {
      addResult({ file: filename, offset, raw: str, category: 'DRIVER', ver: m[1] + 'v' + m[2], sw: '', hw: '', pcb: '', module: m[1] });
    }

    // â”€â”€ rforte_ â”€â”€
    const re7 = new RegExp(RE_RFORTE.source, 'gi');
    while ((m = re7.exec(str)) !== null) {
      addResult({ file: filename, offset, raw: str, category: 'MODULE', ver: m[0], module: m[0], sw: '', hw: '', pcb: '' });
    }
  }

  if (clLines.length > 0) {
    allChangelog.push({ file: filename, lines: clLines });
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CKF PARSER (ROXX â€” XOR 0x21 encoded)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function parseCkf(buf, filename) {
  // CKF files are XOR-encoded with key 0x21
  const decoded = new Uint8Array(buf.length);
  for (let i = 0; i < buf.length; i++) decoded[i] = buf[i] ^ 0x21;

  // Extract null-terminated strings from decoded buffer
  const strings = extractStringsFromBuffer(decoded);

  // State for cluster/board context
  let clusterName = '';
  const clLines = [];

  // Try to get cluster name from filename: B2-FC-V1_4.CKF â†’ B2-FC
  const fnMatch = filename.match(/^([A-Z0-9\-]+?)[-_]V[\d_]+\.ckf$/i);
  if (fnMatch) clusterName = fnMatch[1];

  // Also look for 'CLUSTER ...' and 'SW.Vx.x' in decoded strings
  let swVer = '', hwVer = '', bootVer = '';
  const versionStrings = [];

  for (const { offset, str } of strings) {
    const trimmed = str.trim();

    // Store all strings
    const cat = categorizeCkf(trimmed);
    allStrings.push({ file: filename, offset, str: trimmed, category: cat });

    // Cluster name: "CLUSTER B2 FC"
    const clusterM = trimmed.match(/^CLUSTER\s+(.+)$/i);
    if (clusterM) clusterName = clusterM[1].trim();

    // SW version: "SW.V1.4" or "V1.4"
    const swM = trimmed.match(/^SW[.\s]*V?(\d+\.\d+[\d.]*)$/i);
    if (swM) { swVer = swM[1]; versionStrings.push({ type: 'SW', ver: swM[1] }); }

    // Standalone version like "V1.4", "V1.1" etc.
    const verM = trimmed.match(/^V(\d+\.\d+[\d.]*)$/i);
    if (verM && !swM) versionStrings.push({ type: 'VER', ver: verM[1] });

    // BOOT versions
    if (/^BOOT$/i.test(trimmed)) {
      // Next few strings after BOOT are likely boot partition versions
    }
    const bootM = trimmed.match(/^BOOT\s+V?(\d+\.\d+)/i);
    if (bootM) { bootVer = bootM[1]; versionStrings.push({ type: 'BOOT', ver: bootM[1] }); }

    // Generic dotted versions
    const genM = trimmed.match(/\bV?(\d+\.\d+[\d.]*)\b/i);
    if (genM && trimmed.length < 20) versionStrings.push({ type: 'GENERAL', ver: genM[1] });

    // Module-like strings (channel configs, features)
    if (/strobe|dimmer|colour|color|fan|fixture|channel|macro|calibrat/i.test(trimmed) && trimmed.length > 3 && trimmed.length < 60) {
      addResult({ file: filename, offset, raw: trimmed, category: 'MODULE', module: trimmed, ver: '', sw: swVer, hw: hwVer, pcb: clusterName });
    }

    // Changelog-like lines â€” ÑÑ‚Ñ€Ğ¾Ğ³Ğ° Ñ„Ñ–Ğ»ÑŒÑ‚Ñ€Ğ°Ñ†Ñ–Ñ Ğ²Ñ–Ğ´ Ğ±Ñ–Ğ½Ğ°Ñ€Ğ½Ğ¸Ñ…/lookup Ğ´Ğ°Ğ½Ğ¸Ñ…
    if (isHumanReadable(trimmed)) {
      clLines.push(trimmed);
    }
  }

  // Add version results
  const pcb = clusterName || filename.replace(/\.ckf$/i, '');
  const seenVers = new Set();
  for (const v of versionStrings) {
    if (seenVers.has(v.type + v.ver)) continue;
    seenVers.add(v.type + v.ver);
    if (v.type === 'SW') {
      addResult({ file: filename, offset: 0, raw: `SW.V${v.ver}`, category: 'VERSION_SW', pcb, sw: v.ver, hw: hwVer, module: '', ver: `sw${v.ver}` });
    } else if (v.type === 'BOOT') {
      addResult({ file: filename, offset: 0, raw: `BOOT V${v.ver}`, category: 'GENERAL', pcb, sw: '', hw: '', module: 'BOOT', ver: `V${v.ver}` });
    } else if (v.type === 'VER') {
      addResult({ file: filename, offset: 0, raw: `V${v.ver}`, category: 'GENERAL', pcb, sw: '', hw: '', module: '', ver: `V${v.ver}` });
    }
  }

  // If we found cluster but no SW ver from decoded strings, try filename
  if (!swVer) {
    const fvM = filename.match(/V([\d_]+)\.ckf$/i);
    if (fvM) {
      const fv = fvM[1].replace(/_/g, '.');
      addResult({ file: filename, offset: 0, raw: `V${fv} (from filename)`, category: 'VERSION_SW', pcb, sw: fv, hw: '', module: '', ver: `sw${fv}` });
    }
  }

  if (clLines.length > 0) allChangelog.push({ file: filename, lines: clLines });
}

function extractStringsFromBuffer(buf) {
  const out = [];
  let start = -1, cur = '';
  for (let i = 0; i <= buf.length; i++) {
    const b = i < buf.length ? buf[i] : 0;
    const ok = b >= 0x20 && b <= 0x7E;
    if (ok) { if (start < 0) start = i; cur += String.fromCharCode(b); }
    else {
      if (cur.length >= 3) out.push({ offset: start, str: cur.trim() });
      start = -1; cur = '';
    }
  }
  return out;
}

function categorizeCkf(str) {
  if (/^SW[.\s]*V?\d/i.test(str)) return 'VERSION_SW';
  if (/^BOOT/i.test(str)) return 'GENERAL';
  if (/^V\d+\.\d+/i.test(str)) return 'GENERAL';
  if (/CLUSTER/i.test(str)) return 'MODULE';
  if (/strobe|dimmer|colour|color|fan|fixture/i.test(str)) return 'MODULE';
  return 'STRING';
}

// ĞŸĞµÑ€ĞµĞ²Ñ–Ñ€ÑÑ” Ñ‡Ğ¸ Ñ” Ñ€ÑĞ´Ğ¾Ğº Ñ‡Ğ¸Ñ‚Ğ°Ğ±ĞµĞ»ÑŒĞ½Ğ¸Ğ¼ Ñ‚ĞµĞºÑÑ‚Ğ¾Ğ¼ (Ğ½Ğµ Ğ±Ñ–Ğ½Ğ°Ñ€Ğ½Ğ¸Ğ¹/lookup-Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ñ)
function hasSequentialRun(str, minRun = 6) {
  let run = 1;
  for (let i = 1; i < str.length; i++) {
    const d = str.charCodeAt(i) - str.charCodeAt(i - 1);
    if (d === 1 || d === -1) { if (++run >= minRun) return true; }
    else run = 1;
  }
  return false;
}

function isHumanReadable(str) {
  if (str.length < 5 || str.length > 120) return false;

  // ĞœÑ–Ğ½Ñ–Ğ¼ÑƒĞ¼ 60% Ğ»Ñ–Ñ‚ĞµÑ€ ÑĞµÑ€ĞµĞ´ Ğ²ÑÑ–Ñ… ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ñ–Ğ²
  const letters = (str.match(/[a-zA-Z]/g) || []).length;
  if (letters / str.length < 0.4) return false;

  // ĞĞ±Ğ¾Ğ²'ÑĞ·ĞºĞ¾Ğ²Ğ¾ Ñ” Ğ¿Ñ€Ğ¾Ğ±Ñ–Ğ» Ğ°Ğ±Ğ¾ Ñ†Ğµ Ğ¾Ğ´Ğ½Ğµ Ğ·Ğ½Ğ°Ñ‡ÑƒÑ‰Ğµ ÑĞ»Ğ¾Ğ²Ğ¾ >= 4 Ğ»Ñ–Ñ‚ĞµÑ€
  const hasSpace = /\s/.test(str);
  const words = str.trim().split(/\s+/);
  if (!hasSpace && words[0].length < 4) return false;

  // Ğ’Ñ–Ğ´Ñ…Ğ¸Ğ»ÑÑ”Ğ¼Ğ¾ Ğ¿Ğ¾ÑĞ»Ñ–Ğ´Ğ¾Ğ²Ğ½Ñ– ASCII-ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ğ¸ (lookup tables / gamma curves)
  // ĞĞ·Ğ½Ğ°ĞºĞ°: >= 6 ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ñ–Ğ² Ğ¿Ñ–Ğ´Ñ€ÑĞ´ Ğ· Ñ€Ñ–Ğ·Ğ½Ğ¸Ñ†ĞµÑ 1 Ğ°Ğ±Ğ¾ -1 (ascending/descending runs)
  let runLen = 1;
  for (let i = 1; i < str.length; i++) {
    const diff = str.charCodeAt(i) - str.charCodeAt(i - 1);
    if (diff === 1 || diff === -1) {
      runLen++;
      if (runLen >= 6) return false; // Ğ´Ğ¾Ğ²Ğ³Ğ° Ğ¿Ğ¾ÑĞ»Ñ–Ğ´Ğ¾Ğ²Ğ½Ğ° ÑĞµÑ€Ñ–Ñ â€” Ğ±Ñ–Ğ½Ğ°Ñ€Ğ½Ñ– Ğ´Ğ°Ğ½Ñ–
    } else {
      runLen = 1;
    }
  }

  // Ğ’Ñ–Ğ´Ñ…Ğ¸Ğ»ÑÑ”Ğ¼Ğ¾ Ñ€ÑĞ´ĞºĞ¸ Ğ´Ğµ Ğ±Ñ–Ğ»ÑŒÑˆĞµ 30% ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ñ–Ğ² Ğ½Ğµ-Ğ°Ğ»Ñ„Ğ°Ğ²Ñ–Ñ‚Ğ½Ñ– Ñ– Ğ½Ğµ Ğ¿Ñ€Ğ¾Ğ±Ñ–Ğ» (ĞºÑ€Ñ–Ğ¼ . , - : /)
  const noise = (str.match(/[^a-zA-Z0-9\s.,\-:/()'!?]/g) || []).length;
  if (noise / str.length > 0.25) return false;

  // ĞœÑ–Ğ½Ñ–Ğ¼ÑƒĞ¼ Ğ¾Ğ´Ğ½Ğµ ÑĞ»Ğ¾Ğ²Ğ¾ >= 3 Ğ»Ñ–Ñ‚ĞµÑ€Ğ¸ Ğ¿Ğ¾ÑĞ¿Ñ–Ğ»ÑŒ
  if (!/[a-zA-Z]{3}/.test(str)) return false;

  return true;
}

function addResult(r) {
  // Deduplicate by file+raw+ver combo
  const key = r.file + '|' + r.raw + '|' + r.ver;
  if (!addResult._seen) addResult._seen = new Set();
  if (addResult._seen.has(key)) return;
  addResult._seen.add(key);
  allResults.push(r);
}

function categorize(str) {
  if (/forte_/i.test(str)) return 'MODULE';
  if (/copyright/i.test(str)) return 'COPYRIGHT';
  if (/\bsw\d|\bhw\d|PCB\s*[A-Z]/i.test(str)) return 'VERSION_SW';
  if (/v\d+\.\d+/i.test(str)) return 'GENERAL';
  if (/build|compiler|gcc|clang/i.test(str)) return 'BUILD';
  if (/\d{4}-\d{2}-\d{2}/.test(str)) return 'DATE';
  return 'STRING';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STRING EXTRACTOR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function extractStrings(buf) {
  const out = [];
  let start = -1, cur = '';
  for (let i = 0; i <= buf.length; i++) {
    const b = i < buf.length ? buf[i] : 0;
    const ok = (b >= 0x20 && b <= 0x7E) || b === 0x09;
    if (ok) { if (start < 0) start = i; cur += String.fromCharCode(b); }
    else {
      if (cur.length >= MIN_LEN) out.push({ offset: start, str: cur });
      start = -1; cur = '';
    }
  }
  return out;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER â€“ VERSIONS TAB
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderVersionsTab() {
  applyFilters();
}

function applyFilters() {
  const q    = (document.getElementById('q')?.value || '').toLowerCase().trim();
  const fFile = document.getElementById('file-filter')?.value || '';
  const fCat  = document.getElementById('cat-filter')?.value || '';

  const tbody = document.getElementById('vtbody');
  if (!tbody) return;

  // Ğ¯ĞºÑ‰Ğ¾ Ñ„Ğ°Ğ¹Ğ» Ğ½Ğµ Ğ¾Ğ±Ñ€Ğ°Ğ½Ğ¾, Ğ¿Ğ¾ĞºĞ°Ğ·ÑƒÑ”Ğ¼Ğ¾ Ğ¿Ğ¾Ñ€Ğ¾Ğ¶Ğ½Ñ Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ñ Ğ· Ğ¿Ñ–Ğ´ĞºĞ°Ğ·ĞºĞ¾Ñ
  if (!fFile && fileList.length > 0) {
    tbody.innerHTML = '<tr><td colspan="4" class="empty" style="padding: 60px 20px;">Please select a file from the dropdown above to view results</td></tr>';
    document.getElementById('count-v') && (document.getElementById('count-v').innerHTML = 
      `<span style="color: var(--muted);">Select a file to display entries</span>`);
    filteredResults = [];
    
    // ĞŸĞ¾ĞºĞ°Ğ·ÑƒÑ”Ğ¼Ğ¾ ÑÑ‚Ñ€Ñ–Ğ»ĞºÑƒ-Ğ¿Ñ–Ğ´ĞºĞ°Ğ·ĞºÑƒ
    const hint = document.getElementById('file-select-hint');
    if (hint) hint.style.display = 'block';
    
    return;
  }

  // Ğ¥Ğ¾Ğ²Ğ°Ñ”Ğ¼Ğ¾ ÑÑ‚Ñ€Ñ–Ğ»ĞºÑƒ ÑĞºÑ‰Ğ¾ Ñ„Ğ°Ğ¹Ğ» Ğ¾Ğ±Ñ€Ğ°Ğ½Ğ¾
  const hint = document.getElementById('file-select-hint');
  if (hint && fFile) hint.style.display = 'none';

  let rows = allResults;
  // Ğ¤Ñ–Ğ»ÑŒÑ‚Ñ€ÑƒÑ”Ğ¼Ğ¾ Ñ‰Ğ¾Ğ± Ğ¿Ğ¾ĞºĞ°Ğ·ÑƒĞ²Ğ°Ñ‚Ğ¸ Ñ‚Ñ–Ğ»ÑŒĞºĞ¸ Ñ€ÑĞ´ĞºĞ¸ Ğ· PCB (Ğ²Ğ¸ĞºĞ»ÑÑ‡Ğ°Ñ”Ğ¼Ğ¾ Ğ¿ÑƒÑÑ‚Ñ– Ñ‚Ğ° "â€”")
  rows = rows.filter(r => r.pcb && r.pcb !== 'â€”' && r.pcb.trim() !== '');
  if (fFile) rows = rows.filter(r => r.file === fFile);
  if (fCat)  rows = rows.filter(r => r.category === fCat);
  if (q)     rows = rows.filter(r =>
    r.file.toLowerCase().includes(q) ||
    r.raw.toLowerCase().includes(q) ||
    r.ver.toLowerCase().includes(q) ||
    r.module.toLowerCase().includes(q) ||
    r.pcb.toLowerCase().includes(q)
  );

  if (uniqueMode) {
    const seen = new Set();
    rows = rows.filter(r => {
      const k = r.category + '|' + r.ver + '|' + r.module + '|' + r.pcb;
      if (seen.has(k)) return false;
      seen.add(k); return true;
    });
  }

  // Sort
  rows = [...rows].sort((a,b) => {
    const av = a[sortCol] || '', bv = b[sortCol] || '';
    return av < bv ? -sortDir : av > bv ? sortDir : 0;
  });

  // Ğ—Ğ±ĞµÑ€Ñ–Ğ³Ğ°Ñ”Ğ¼Ğ¾ Ğ²Ñ–Ğ´Ñ„Ñ–Ğ»ÑŒÑ‚Ñ€Ğ¾Ğ²Ğ°Ğ½Ñ– Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ğ¸ Ğ´Ğ»Ñ ĞµĞºÑĞ¿Ğ¾Ñ€Ñ‚Ñƒ
  filteredResults = rows;

  document.getElementById('count-v') && (document.getElementById('count-v').innerHTML =
    `Showing <b>${rows.length.toLocaleString()}</b> entries`);

  if (!rows.length) { tbody.innerHTML = '<tr><td colspan="4" class="empty">No results match the current filter.</td></tr>'; return; }

  tbody.innerHTML = rows.slice(0, 3000).map(r => `
    <tr>
      <td class="td-file"><span title="${escH(r.file)}">${escH(shortName(r.file))}</span></td>
      <td><span class="ver-badge ${catBadge(r.category)}">${escH(r.category.replace('VERSION_',''))}</span></td>
      <td class="td-pcb">${escH(r.pcb || 'â€”')}</td>
      <td>
        ${r.sw ? `<span class="ver-badge ver-sw">sw${escH(formatSwVersion(r.sw))}</span>` : ''}
        ${r.hw ? `<span class="ver-badge ver-hw">hw${escH(r.hw)}</span>` : ''}
        ${(!r.sw && !r.hw) ? `<span class="ver-badge ${catBadge(r.category)}">${escH(r.ver)}</span>` : ''}
      </td>
    </tr>
  `).join('');
}

function catBadge(cat) {
  return { VERSION_SW:'ver-sw', VERSION_HW:'ver-hw', MODULE:'ver-mod', DRIVER:'ver-drv', GENERAL:'ver-generic' }[cat] || 'ver-generic';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER â€“ MODULES TAB
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderModulesTab() {
  const el = document.getElementById('tab-modules');
  const entries = Object.values(allModules);
  if (!entries.length) { el.innerHTML = '<div class="empty">No forte_* modules detected.</div>'; return; }

  entries.sort((a,b) => a.module.localeCompare(b.module));

  const cards = entries.map(e => {
    const vers = e.versions.sort((a,b)=>a-b).map(v => `<span class="ver-badge ver-mod">v${v}</span>`).join(' ');
    const files = e.files.map(f => `<span style="font-size:11px;color:var(--blue)">${escH(shortName(f))}</span>`).join(', ');
    return `
      <div class="mod-card">
        <div class="mod-card-title">${escH(e.module)}</div>
        <div class="mod-card-file">${files}</div>
        <div>${vers}</div>
      </div>`;
  }).join('');

  el.innerHTML = `<div class="mod-grid fade-in">${cards}</div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER â€“ STRINGS TAB
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderStringsTab() {
  const el = document.getElementById('tab-strings');
  const rows = allStrings.filter(s => s.category !== 'STRING').slice(0, 4000);

  if (!rows.length) { el.innerHTML = '<div class="empty">No relevant strings found.</div>'; return; }

  const rowsHtml = rows.map(s => {
    const preview = s.str.length > 100 ? s.str.slice(0, 100) + 'â€¦' : s.str;
    return `<div class="str-row">
      <div style="font-size:11px;color:var(--blue);overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${escH(s.file)}">${escH(shortName(s.file))}</div>
      <div style="font-size:11px;color:var(--muted)">0x${s.offset.toString(16).toUpperCase().padStart(6,'0')}</div>
      <div style="font-size:12px;word-break:break-all">${escH(preview)}</div>
      <div><span class="ver-badge ${catBadge(s.category)}" style="font-size:9px">${escH(s.category)}</span></div>
    </div>`;
  }).join('');

  el.innerHTML = `
    <div class="str-tbl fade-in">
      <div class="str-tbl-head"><span>File</span><span>Offset</span><span>String</span><span>Category</span></div>
      <div class="str-body">${rowsHtml}</div>
    </div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER â€“ CHANGELOG TAB
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderChangelogTab() {
  const el = document.getElementById('tab-changelog');
  if (!allChangelog.length) { el.innerHTML = '<div class="empty">No changelog entries detected.</div>'; return; }

  const cards = allChangelog.map(c => {
    const lines = c.lines.map(l => {
      const hl = l.replace(/\b(v\d+[\d.]*|sw\s*\d+|hw\s*\d+|\bRB\d+v\d+)/gi, '<span class="cl-highlight">$1</span>');
      return `<div class="cl-line">${escH2(hl)}</div>`;
    }).join('');
    return `<div class="cl-entry fade-in"><div class="cl-file">ğŸ“„ ${escH(c.file)}</div>${lines}</div>`;
  }).join('');

  el.innerHTML = cards;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SUMMARY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderSummary() {
  const mods  = Object.keys(allModules).length;
  const swVer = new Set(allResults.filter(r=>r.sw).map(r=>r.sw)).size;
  const hwVer = new Set(allResults.filter(r=>r.hw).map(r=>r.hw)).size;
  const clTot = allChangelog.reduce((s,c)=>s+c.lines.length, 0);

  document.getElementById('stat-row').innerHTML = `
    <div class="stat-box c1 fade-in"><div class="stat-n">${fileList.length}</div><div class="stat-l">Files processed</div></div>
    <div class="stat-box c2 fade-in"><div class="stat-n">${mods}</div><div class="stat-l">forte_* modules</div></div>
    <div class="stat-box c3 fade-in"><div class="stat-n">${swVer}</div><div class="stat-l">SW versions</div></div>
    <div class="stat-box c4 fade-in"><div class="stat-n">${hwVer}</div><div class="stat-l">HW versions</div></div>
    <div class="stat-box c5 fade-in"><div class="stat-n">${clTot}</div><div class="stat-l">Changelog lines</div></div>
  `;

  // Also build versions table structure
  document.getElementById('tab-versions').innerHTML = `
    <div class="count-line" id="count-v"></div>
    <div class="tbl-wrap">
      <div class="tbl-scroll">
        <table class="main-tbl">
          <thead><tr>
            <th onclick="setSort('file')">File<span class="sort-ico">â†•</span></th>
            <th onclick="setSort('category')">Type<span class="sort-ico">â†•</span></th>
            <th onclick="setSort('pcb')">PCB<span class="sort-ico">â†•</span></th>
            <th onclick="setSort('ver')">Version<span class="sort-ico">â†•</span></th>
          </tr></thead>
          <tbody class="tbody-scroll" id="vtbody"></tbody>
        </table>
      </div>
    </div>`;
  applyFilters();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PROGRESS UI
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setProgress(done, total, label) {
  const pct = total ? Math.round(done / total * 100) : 0;
  document.getElementById('pf').style.width = pct + '%';
  document.getElementById('ppct').textContent = pct + '%';
  document.getElementById('plbl').textContent = `Processing: ${label} (${done}/${total})`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SORT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setSort(col) {
  if (sortCol === col) sortDir *= -1;
  else { sortCol = col; sortDir = 1; }
  document.querySelectorAll('.main-tbl th').forEach(th => th.classList.remove('sorted'));
  event.target.closest('th').classList.add('sorted');
  applyFilters();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EXPORT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function exportCSV() {
  const hdr = 'File,Category,PCB,SW,HW\n';
  const rows = filteredResults.map(r =>
    [
      r.file, 
      r.category.replace('VERSION_',''), 
      r.pcb, 
      r.sw ? 'sw' + formatSwVersion(r.sw) : '', 
      r.hw ? 'hw' + r.hw : ''
    ]
    .map(v => `"${String(v).replace(/"/g,'""')}"`)
    .join(',')
  ).join('\n');
  download('firmware_versions.csv', hdr + rows, 'text/csv');
}

function exportJSON() {
  const data = {
    files: fileList.map(f=>f.name),
    modules: allModules,
    results: filteredResults,
    changelog: allChangelog,
  };
  download('firmware_analysis.json', JSON.stringify(data, null, 2), 'application/json');
}

function download(name, content, mime) {
  const a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob([content], { type: mime }));
  a.download = name; a.click();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildFileFilter() {
  const sel = document.getElementById('file-filter');
  if (!sel) return;
  fileList.forEach(f => {
    const opt = document.createElement('option');
    opt.value = f.name; opt.textContent = shortName(f.name);
    sel.appendChild(opt);
  });
}

function onFileFilterChange() {
  applyFilters();
  showFileChangelog();
}

function showFileChangelog() {
  const selectedFile = document.getElementById('file-filter')?.value;
  const panel = document.getElementById('file-changelog-panel');
  const content = document.getElementById('file-changelog-content');
  const filename = document.getElementById('changelog-filename');
  
  if (!selectedFile) {
    panel.style.display = 'none';
    return;
  }
  
  // Ğ—Ğ½Ğ°Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ğ¾ changelog Ğ´Ğ»Ñ Ğ¾Ğ±Ñ€Ğ°Ğ½Ğ¾Ğ³Ğ¾ Ñ„Ğ°Ğ¹Ğ»Ñƒ
  const fileChangelog = allChangelog.find(c => c.file === selectedFile);
  
  if (!fileChangelog || !fileChangelog.lines.length) {
    content.innerHTML = '<div class="file-cl-empty">No changelog entries found for this file.</div>';
    filename.textContent = selectedFile;
    panel.style.display = 'block';
    return;
  }
  
  // Ğ¤ÑƒĞ½ĞºÑ†Ñ–Ñ Ğ´Ğ»Ñ Ğ¾Ñ‡Ğ¸Ñ‰ĞµĞ½Ğ½Ñ Ğ²Ñ–Ğ´ Ğ½ĞµÑ‡Ğ¸Ñ‚Ğ°Ğ±ĞµĞ»ÑŒĞ½Ğ¸Ñ… ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ñ–Ğ²
  function cleanText(text) {
    return text
      .replace(/[^\x20-\x7E\u00A0-\uFFFF]/g, '')
      .replace(/[\x00-\x1F\x7F-\x9F]/g, '')
      .trim();
  }
  
  // Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚ÑƒÑ”Ğ¼Ğ¾ changelog Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸
  const lines = fileChangelog.lines
    .map(line => cleanText(line))
    .filter(line => line.length > 0) // Ğ—Ğ°Ğ»Ğ¸ÑˆĞ°Ñ”Ğ¼Ğ¾ Ğ²ÑÑ– Ğ½ĞµĞ¿ÑƒÑÑ‚Ñ– Ğ»Ñ–Ğ½Ñ–Ñ—
    .map(line => {
      // ĞŸĞµÑ€ĞµĞ²Ñ–Ñ€ÑÑ”Ğ¼Ğ¾ Ñ‡Ğ¸ Ñ†Ğµ Ğ·Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²Ğ¾Ğº Ğ²ĞµÑ€ÑÑ–Ñ—
      if (/^===\s*(.+)\s*===$/.test(line)) {
        const version = line.match(/^===\s*(.+)\s*===$/)[1];
        return `<div style="font-family: var(--ui); font-size: 16px; font-weight: 700; color: var(--green); margin: 20px 0 10px 0; padding-bottom: 8px; border-bottom: 2px solid var(--border);">${escH(version)}</div>`;
      }
      
      // ĞŸÑ€Ğ¾Ğ¿ÑƒÑĞºĞ°Ñ”Ğ¼Ğ¾ Ğ¿ÑƒÑÑ‚Ñ– Ğ»Ñ–Ğ½Ñ–Ñ— (Ğ´Ğ»Ñ Ğ²Ñ–Ğ´ÑÑ‚ÑƒĞ¿Ñ–Ğ² Ğ¼Ñ–Ğ¶ Ğ²ĞµÑ€ÑÑ–ÑĞ¼Ğ¸)
      if (line === '') {
        return '<div style="height: 10px;"></div>';
      }
      
      // Ğ’Ğ¸Ğ´Ğ°Ğ»ÑÑ”Ğ¼Ğ¾ Ğ½ĞµĞ²Ğ°Ğ»Ñ–Ğ´Ğ½Ñ– Ñ€ÑĞ´ĞºĞ¸ (Ñ‚Ñ–Ğ»ÑŒĞºĞ¸ ÑĞ¿ĞµÑ†ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ğ¸, ĞºĞ¾Ñ€Ğ¾Ñ‚ĞºÑ– Ğ±ĞµĞ· Ğ·Ğ¼Ñ–ÑÑ‚Ñƒ)
      if (!/[a-zA-Z0-9]/.test(line) || line.length < 3) {
        return '';
      }
      
      // Escape HTML ÑĞ¿Ğ¾Ñ‡Ğ°Ñ‚ĞºÑƒ
      const escaped = escH(line);
      
      // ĞŸÑ–Ğ´ÑĞ²Ñ–Ñ‡ÑƒÑ”Ğ¼Ğ¾ Ğ²ĞµÑ€ÑÑ–Ñ— Ñ‚Ğ° Ğ²Ğ°Ğ¶Ğ»Ğ¸Ğ²Ñ– ÑĞ»Ğ¾Ğ²Ğ°
      const highlighted = escaped
        .replace(/\b(v\d+[\d.]*|sw\s*\d+|hw\s*\d+|\bRB\d+v\d+)/gi, '<span class="file-cl-highlight">$1</span>')
        .replace(/\b(added|fixed|changed|updated|removed|improved|fix|change|add|update|remove|improve|correction|optimization)/gi, '<span class="file-cl-highlight">$1</span>');
      
      return `<div class="file-cl-line">${highlighted}</div>`;
    })
    .filter(line => line !== ''); // Ğ’Ğ¸Ğ´Ğ°Ğ»ÑÑ”Ğ¼Ğ¾ Ğ¿ÑƒÑÑ‚Ñ– Ñ€ÑĞ´ĞºĞ¸
  
  if (lines.length === 0) {
    content.innerHTML = '<div class="file-cl-empty">No readable changelog entries found for this file.</div>';
  } else {
    content.innerHTML = lines.join('');
  }
  
  filename.textContent = selectedFile;
  panel.style.display = 'block';
  
  // Scroll Ğ´Ğ¾ Ğ¿Ğ°Ğ½ĞµĞ»Ñ–
  setTimeout(() => {
    panel.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  }, 100);
}

function closeFileChangelog() {
  document.getElementById('file-changelog-panel').style.display = 'none';
}

function toggleUnique() {
  uniqueMode = !uniqueMode;
  document.getElementById('btn-unique').classList.toggle('active', uniqueMode);
  applyFilters();
}

function switchTab(name, el) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
  el.classList.add('active');
  document.getElementById('tab-' + name).classList.add('active');
}

function clearAll(silent) {
  allResults = []; allStrings = []; allModules = {}; allChangelog = []; fileList = [];
  addResult._seen = new Set();
  uniqueMode = false;
  if (!silent) {
    document.getElementById('summary').style.display = 'none';
    document.getElementById('tabs').style.display   = 'none';
    document.getElementById('ctrl').style.display   = 'none';
    document.getElementById('pw').style.display     = 'none';
    document.getElementById('fin').value = '';
    ['tab-versions','tab-modules','tab-strings','tab-changelog'].forEach(id => {
      document.getElementById(id).innerHTML = '';
    });
    const sel = document.getElementById('file-filter');
    if (sel) sel.innerHTML = '<option value="">All files</option>';
  }
}

function shortName(n) { return n.length > 28 ? 'â€¦' + n.slice(-26) : n; }
function fmtSize(n) { return n < 1024 ? n+'B' : n < 1048576 ? (n/1024).toFixed(0)+'KB' : (n/1048576).toFixed(1)+'MB'; }
function escH(s) { return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
// escH2 allows pre-escaped HTML spans through
function escH2(s) { return s.replace(/&(?!amp;|lt;|gt;|quot;|#)/g,'&amp;'); }
// Format SW version: 10 -> 1.0, 32 -> 3.2, etc.
function formatSwVersion(sw) {
  const num = parseInt(sw, 10);
  if (isNaN(num) || num < 10) return sw;
  const str = num.toString();
  return str.slice(0, -1) + '.' + str.slice(-1);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TITLE ANIMATIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function changeAnimation(type) {
  const title = document.getElementById('animated-title');
  
  // Ğ’Ğ¸Ğ´Ğ°Ğ»ÑÑ”Ğ¼Ğ¾ Ğ²ÑÑ– ĞºĞ»Ğ°ÑĞ¸ Ğ°Ğ½Ñ–Ğ¼Ğ°Ñ†Ñ–Ğ¹
  title.className = '';
  
  // Ğ”Ğ¾Ğ´Ğ°Ñ”Ğ¼Ğ¾ Ğ½Ğ¾Ğ²Ğ¸Ğ¹ ĞºĞ»Ğ°Ñ
  switch(type) {
    case 'gradient-flow':
      title.className = 'title-gradient-flow';
      // Ğ”Ğ¾Ğ´Ğ°Ñ”Ğ¼Ğ¾ Ñ€Ğ°Ğ½Ğ´Ğ¾Ğ¼Ğ½Ñ– Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ½Ñ Ğ´Ğ»Ñ Ñ…Ğ°Ğ¾Ñ‚Ğ¸Ñ‡Ğ½Ğ¾Ñ— Ğ°Ğ½Ñ–Ğ¼Ğ°Ñ†Ñ–Ñ—
      const letters = title.querySelectorAll('.letter');
      letters.forEach((letter, i) => {
        letter.style.setProperty('--i', i);
        letter.style.setProperty('--random', Math.random());
        letter.style.setProperty('--scale-1', 0.95 + Math.random() * 0.3); // 0.95-1.25
        letter.style.setProperty('--scale-2', 0.85 + Math.random() * 0.2); // 0.85-1.05
        letter.style.setProperty('--scale-3', 1.0 + Math.random() * 0.25); // 1.0-1.25
      });
      break;
    case 'wave':
      title.className = 'title-wave';
      // Ğ”Ğ¾Ğ´Ğ°Ñ”Ğ¼Ğ¾ CSS Ğ·Ğ¼Ñ–Ğ½Ğ½Ñƒ Ğ´Ğ»Ñ ĞºĞ¾Ğ¶Ğ½Ğ¾Ñ— Ğ»Ñ–Ñ‚ĞµÑ€Ğ¸
      const waveLetters = title.querySelectorAll('.letter');
      waveLetters.forEach((letter, i) => {
        letter.style.setProperty('--i', i);
      });
      break;
    case 'pulse':
      title.className = 'title-pulse';
      break;
    case 'typing':
      title.className = 'title-typing';
      break;
    case 'glitch':
      title.className = 'title-glitch';
      title.setAttribute('data-text', title.textContent.trim());
      break;
    case 'none':
      title.className = 'title-none';
      break;
  }
  
  // Ğ—Ğ±ĞµÑ€Ñ–Ğ³Ğ°Ñ”Ğ¼Ğ¾ Ğ²Ğ¸Ğ±Ñ–Ñ€
  localStorage.setItem('titleAnimation', type);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LIBRARY SWITCHER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const LIBRARIES = {
  robin:    { name: 'ROBE',      emoji: 'ğŸ“¦' },
  roxx:     { name: 'ROXX',      emoji: 'ğŸ”µ' },
  claypaky: { name: 'Clay Paky', emoji: 'ğŸŸ¡' },
};
const LIB_ORDER = ['robin', 'roxx', 'claypaky'];

let currentLib = 'robin';

function cycleLibrary() {
  const idx = LIB_ORDER.indexOf(currentLib);
  const nextLib = LIB_ORDER[(idx + 1) % LIB_ORDER.length];
  switchLibrary(nextLib);
}

const LIB_CONFIG = {
  robin:    { accept: '.lib,.a,.bin', title: 'Drop up to 250 .lib / .a / .bin files here', icon: 'ğŸ“¦' },
  roxx:     { accept: '.ckf',         title: 'Drop up to 250 .ckf files here',              icon: 'ğŸ”µ' },
  claypaky: { accept: '.lib,.a,.bin', title: 'Drop up to 250 .lib / .a / .bin files here', icon: 'ğŸŸ¡' },
};

function updateDropZone(lib) {
  const cfg = LIB_CONFIG[lib];
  document.getElementById('fin').accept = cfg.accept;
  document.getElementById('drop-icon').textContent = cfg.icon;
  document.getElementById('drop-title').textContent = cfg.title;
}

function switchLibrary(lib) {
  currentLib = lib;

  // Update body class for accent color
  document.body.className = document.body.className.replace(/\bmode-\w+/g, '').trim();
  document.body.classList.add('mode-' + lib);

  // Update title text
  setTitleText(LIBRARIES[lib].name);

  // Update browser tab title
  document.title = LIBRARIES[lib].name;

  // Update drop zone
  updateDropZone(lib);

  // Ğ—Ğ±ĞµÑ€Ñ–Ğ³Ğ°Ñ”Ğ¼Ğ¾ Ğ²Ğ¸Ğ±Ñ–Ñ€
  localStorage.setItem('activeLibrary', lib);

  // Clear data when switching library
  clearAll();

  // Re-apply current animation with new letters
  const savedAnimation = localStorage.getItem('titleAnimation') || 'gradient-flow';
  changeAnimation(savedAnimation);
}

function setTitleText(text) {
  const title = document.getElementById('animated-title');
  const currentClass = title.className;
  title.innerHTML = '';

  for (let i = 0; i < text.length; i++) {
    const ch = text[i];
    const span = document.createElement('span');
    if (ch === ' ') {
      span.className = 'letter space';
      span.innerHTML = ' ';
    } else {
      span.className = 'letter';
      span.textContent = ch;
    }
    title.appendChild(span);
  }
  // Restore class
  title.className = currentClass;
}

window.addEventListener('DOMContentLoaded', () => {
  // Ğ’Ñ–Ğ´Ğ½Ğ¾Ğ²Ğ»ÑÑ”Ğ¼Ğ¾ Ğ·Ğ±ĞµÑ€ĞµĞ¶ĞµĞ½Ñƒ Ğ±Ñ–Ğ±Ğ»Ñ–Ğ¾Ñ‚ĞµĞºÑƒ
  const savedLib = localStorage.getItem('activeLibrary') || 'robin';
  currentLib = savedLib;
  document.body.classList.add('mode-' + savedLib);
  document.title = LIBRARIES[savedLib].name;
  setTitleText(LIBRARIES[savedLib].name);
  updateDropZone(savedLib);

  // Ğ—Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ÑƒÑ”Ğ¼Ğ¾ Ğ·Ğ±ĞµÑ€ĞµĞ¶ĞµĞ½Ñƒ Ğ°Ğ½Ñ–Ğ¼Ğ°Ñ†Ñ–Ñ
  const savedAnimation = localStorage.getItem('titleAnimation') || 'gradient-flow';
  const select = document.getElementById('animation-select');
  if (select) {
    select.value = savedAnimation;
    changeAnimation(savedAnimation);
  }
  
  // ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ñ‚Ğ¸/ÑÑ…Ğ¾Ğ²Ğ°Ñ‚Ğ¸ ÑĞµĞ»ĞµĞºÑ‚Ğ¾Ñ€ Ğ°Ğ½Ñ–Ğ¼Ğ°Ñ†Ñ–Ğ¹ Ğ¿Ğ¾ Ctrl+Shift+A
  document.addEventListener('keydown', (e) => {
    if (e.ctrlKey && e.shiftKey && e.key === 'A') {
      const selector = document.getElementById('animation-selector');
      selector.style.display = selector.style.display === 'none' ? 'block' : 'none';
    }
  });
});
</script>
</body>
</html>
